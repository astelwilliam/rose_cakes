{% extends 'rose_cakes/base.html' %}

{% block title %}{{ cake.name }} - Rose Cakes{% endblock %}

{% block content %}
<section class="feature-section py-5">
    <div class="container">
        <div class="row g-4">
            <div class="col-lg-6" data-aos="fade-right">
                <div class="card shadow cake-card">
                    {% if cake.image %}
                        <img src="{{ cake.image.url }}" class="card-img-top" alt="{{ cake.name }}">
                    {% else %}
                        <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 400px;">
                            <span class="text-muted fs-3">No Image</span>
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-lg-6" data-aos="fade-left" data-aos-delay="200">
                <div class="card shadow h-100 cake-card">
                    <div class="card-body d-flex flex-column">
                        <h1 class="card-title mb-3" style="color: #4a5568;">{{ cake.name }}</h1>
                        {% if cake.category %}
                            <span class="badge bg-primary mb-3 fs-6">{{ cake.category.name }}</span>
                        {% endif %}
                        <p class="card-text lead mb-4">{{ cake.description }}</p>
                        <div class="mt-auto">
                            <h3 class="text-primary mb-3">â‚¹{{ cake.price }}</h3>
                            <p class="text-muted mb-4"><strong>Weight:</strong> {{ cake.weight }} kg</p>
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <form method="post" action="{% url 'add_to_cart' cake.id %}" class="add-to-cart-form">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-primary btn-lg w-100">
                                            <span class="btn-text">Add to Cart</span>
                                            <span class="btn-loading d-none">
                                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                                Adding...
                                            </span>
                                        </button>
                                    </form>
                                </div>
                                <div class="col-6">
                                    <form method="post" action="{% url 'buy_now' cake.id %}">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-outline-primary btn-lg w-100">Buy Now</button>
                                    </form>
                                </div>
                            </div>
                            <a href="{% url 'catalog' %}" class="btn btn-outline-secondary w-100">Back to Menu</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-12" data-aos="fade-up">
                <div class="card shadow cake-card">
                    <div class="card-body">
                        <h3 class="card-title mb-3" style="color: #4a5568;">Why You'll Love This Cake</h3>
                        <div class="row">
                            <div class="col-md-4 mb-3" data-aos="zoom-in" data-aos-delay="200">
                                <div class="text-center">
                                    <i class="fas fa-utensils fs-2 text-primary mb-2"></i>
                                    <h5>Fresh Ingredients</h5>
                                    <p>Made with the finest, freshest ingredients</p>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3" data-aos="zoom-in" data-aos-delay="400">
                                <div class="text-center">
                                    <i class="fas fa-heart fs-2 text-danger mb-2"></i>
                                    <h5>Handcrafted</h5>
                                    <p>Carefully crafted by our expert bakers</p>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3" data-aos="zoom-in" data-aos-delay="600">
                                <div class="text-center">
                                    <i class="fas fa-clock fs-2 text-warning mb-2"></i>
                                    <h5>Perfect Timing</h5>
                                    <p>Delivered fresh at the right time</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Toast Notification Container -->
<div id="cart-toast" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="cart-toast-element" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                <span id="toast-message"></span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<style>
    .cart-animation {
        animation: cartBounce 0.6s ease;
    }
    
    @keyframes cartBounce {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    .toast {
        min-width: 300px;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle Add to Cart with AJAX
    const addToCartForms = document.querySelectorAll('.add-to-cart-form');
    const toastElement = document.getElementById('cart-toast-element');
    const toastMessage = document.getElementById('toast-message');
    const toast = new bootstrap.Toast(toastElement);

    addToCartForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const button = form.querySelector('button[type="submit"]');
            const btnText = button.querySelector('.btn-text');
            const btnLoading = button.querySelector('.btn-loading');
            
            // Show loading state
            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            button.disabled = true;
            
            // Get CSRF token
            const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Make AJAX request
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                },
                body: new FormData(form)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success animation
                    button.classList.add('cart-animation');
                    setTimeout(() => button.classList.remove('cart-animation'), 600);
                    
                    // Show toast notification
                    toastMessage.textContent = data.message;
                    toast.show();
                    
                    // Update cart count in navbar if exists
                    const cartLink = document.querySelector('a[href*="cart"]');
                    if (cartLink && data.total_items) {
                        let cartBadge = cartLink.querySelector('.badge');
                        if (!cartBadge) {
                            cartBadge = document.createElement('span');
                            cartBadge.className = 'badge bg-danger ms-1';
                            cartLink.appendChild(cartBadge);
                        }
                        cartBadge.textContent = data.total_items;
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                toastMessage.textContent = 'Error adding to cart. Please try again.';
                toastElement.classList.remove('bg-success');
                toastElement.classList.add('bg-danger');
                toast.show();
                setTimeout(() => {
                    toastElement.classList.remove('bg-danger');
                    toastElement.classList.add('bg-success');
                }, 3000);
            })
            .finally(() => {
                // Reset button state
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');
                button.disabled = false;
            });
        });
    });
});
</script>
{% endblock %}
