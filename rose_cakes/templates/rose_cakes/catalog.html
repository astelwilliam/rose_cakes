{% extends 'rose_cakes/base.html' %}

{% block title %}Menu - Rose Cakes{% endblock %}

{% block content %}
<section class="feature-section py-5">
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="mb-3" style="color: #4a5568;">Our Cake Menu</h1>
                <p class="lead">Discover our delicious collection of cakes</p>
            </div>
        </div>

        <!-- Category Filter Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card cake-card">
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-6">
                                <label for="categoryFilter" class="form-label">Category</label>
                                <select class="form-select" id="categoryFilter">
                                    <option value="">All Categories</option>
                                    {% for category in categories %}
                                        <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if cakes %}
            <div class="row g-4">
                {% for cake in cakes %}
                    <div class="col-xl-3 col-lg-4 col-md-6" data-aos="zoom-in" data-aos-delay="{% if forloop.counter0 == 0 %}0{% elif forloop.counter0 == 1 %}100{% elif forloop.counter0 == 2 %}200{% elif forloop.counter0 == 3 %}300{% elif forloop.counter0 == 4 %}400{% elif forloop.counter0 == 5 %}500{% else %}600{% endif %}">
                        <div class="card h-100 shadow-sm cake-card">
                            {% if cake.image %}
                                <img src="{{ cake.image.url }}" class="card-img-top" alt="{{ cake.name }}">
                            {% else %}
                                <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                    <span class="text-muted">No Image</span>
                                </div>
                            {% endif %}
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">{{ cake.name }}</h5>
                                {% if cake.category %}
                                    <span class="badge bg-secondary mb-2">{{ cake.category.name }}</span>
                                {% endif %}
                                <p class="card-text flex-grow-1">{{ cake.description|truncatechars:100 }}</p>
                                <div class="mt-auto">
                                    <p class="card-text mb-1"><strong class="text-primary fs-5">â‚¹{{ cake.price }}</strong></p>
                                    <p class="card-text mb-2"><small class="text-muted">{{ cake.weight }} kg</small></p>
                                    <div class="row g-1">
                                        <div class="col-6">
                                            <form method="post" action="{% url 'add_to_cart' cake.id %}" class="add-to-cart-form">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-primary btn-sm w-100">
                                                    <span class="btn-text">Add to Cart</span>
                                                    <span class="btn-loading d-none">
                                                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                                        Adding...
                                                    </span>
                                                </button>
                                            </form>
                                        </div>
                                        <div class="col-6">
                                            <form method="post" action="{% url 'buy_now' cake.id %}">
                                                {% csrf_token %}
                                                <button type="submit" class="btn btn-outline-primary btn-sm w-100">Buy Now</button>
                                            </form>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <a href="{% url 'cake_detail' cake.id %}" class="btn btn-outline-primary btn-sm w-100">View Details</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <p class="text-muted fs-4">No cakes available at the moment.</p>
                <a href="{% url 'homepage' %}" class="btn btn-primary btn-lg">Back to Home</a>
            </div>
        {% endif %}
    </div>
</section>

<!-- Toast Notification Container -->
<div id="cart-toast" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <div id="cart-toast-element" class="toast align-items-center text-white bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                <span id="toast-message"></span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    </div>
</div>

<style>
    .cart-animation {
        animation: cartBounce 0.6s ease;
    }
    
    @keyframes cartBounce {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    .toast {
        min-width: 300px;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const categoryFilter = document.getElementById('categoryFilter');

    function updateFilters() {
        const category = categoryFilter.value;

        const params = new URLSearchParams();
        if (category) params.append('category', category);

        const url = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.location.href = url;
    }

    categoryFilter.addEventListener('change', updateFilters);

    // Handle Add to Cart with AJAX
    const addToCartForms = document.querySelectorAll('.add-to-cart-form');
    const toastElement = document.getElementById('cart-toast-element');
    const toastMessage = document.getElementById('toast-message');
    const toast = new bootstrap.Toast(toastElement);

    addToCartForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const button = form.querySelector('button[type="submit"]');
            const btnText = button.querySelector('.btn-text');
            const btnLoading = button.querySelector('.btn-loading');
            const originalText = btnText.textContent;
            
            // Show loading state
            btnText.classList.add('d-none');
            btnLoading.classList.remove('d-none');
            button.disabled = true;
            
            // Get CSRF token
            const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Make AJAX request
            fetch(form.action, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                },
                body: new FormData(form)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success animation
                    button.classList.add('cart-animation');
                    setTimeout(() => button.classList.remove('cart-animation'), 600);
                    
                    // Show toast notification
                    toastMessage.textContent = data.message;
                    toast.show();
                    
                    // Update cart count in navbar if exists
                    const cartLink = document.querySelector('a[href*="cart"]');
                    if (cartLink && data.total_items) {
                        let cartBadge = cartLink.querySelector('.badge');
                        if (!cartBadge) {
                            cartBadge = document.createElement('span');
                            cartBadge.className = 'badge bg-danger ms-1';
                            cartLink.appendChild(cartBadge);
                        }
                        cartBadge.textContent = data.total_items;
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                toastMessage.textContent = 'Error adding to cart. Please try again.';
                toastElement.classList.remove('bg-success');
                toastElement.classList.add('bg-danger');
                toast.show();
                setTimeout(() => {
                    toastElement.classList.remove('bg-danger');
                    toastElement.classList.add('bg-success');
                }, 3000);
            })
            .finally(() => {
                // Reset button state
                btnText.classList.remove('d-none');
                btnLoading.classList.add('d-none');
                button.disabled = false;
            });
        });
    });
});
</script>
{% endblock %}
